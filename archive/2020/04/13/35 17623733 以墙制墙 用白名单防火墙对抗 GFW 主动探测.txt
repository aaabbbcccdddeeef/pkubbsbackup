#t 35 17623733 hiaoxui 2020-04-13 00:17:00 QUESTIONSSS 2020-04-14 09:39:00
以墙制墙 用白名单防火墙对抗 GFW 主动探测

#p 22215293 hiaoxui 小辉 2020-04-13 17:10:25


2020-04-13 17:07:10
题外话: 我已经恢复了我的所有 IPv4 SSR 节点. 请参考这个帖子中置顶的内容:
[https://bbs.pku.edu.cn/v2/post-read.php?bid=35&amp;threadid=16264150](post-read.php?bid=35&amp;threadid=16264150)
-----------------------------------------------------------------------------------------------------------
GFW 的工作原理非常复杂, 但总体而言可以划分为两个步骤, 被动的嗅探和主动的探测. 前者是墙抓取数据包分析流量特征, 从而识别翻墙流量. 随着翻墙协议的进步, 这样能获取的信息越来越少, GFW 开始主动探测服务器. 下面这篇文章分析了这种行为: 
[https://gfw.report/blog/gfw_shadowsocks/zh.html](jump-to.php?url=https%3A%2F%2Fgfw.report%2Fblog%2Fgfw_shadowsocks%2Fzh.html)
我们当然可以有很多手段伪装我们的服务器, 比如把我们的站点伪装成一个正常的 http 网站, 把流量伪装为 tls 流量. 但这总会有一些缺陷. 一种很简单, 也很极端的思路是: 白名单策略.
白名单策略是指, 我们只允许服务器接收特定 IP 来源的流量, 而拒绝所有别的流量. 每次翻墙之前, 我们用另一台服务器来把你的 IP 地址记录到翻墙服务器中, 从而让你的流量被翻墙服务器接受. 这样我们就可以很大程度规避墙的主动探测.
事实上白名单的列表可以适当增大一些. 经过研究我们发现, 被 GFW 用作主动探测的服务器全部都是 Linux 服务器. 如果我们能过滤掉所有 Linux 发出的包, 也可以实现不被主动探测的目的. 比如一个简单的思路就是, Windows 发出的 IP packet 起始 TTL 是 128, 而 *nix 却是 64. 一般而言从 client 到服务器节点之间的跳数在 20 附近, 那我们只要把所有 TTL 小于 64 的包过滤掉即可. 当然这样我们就只能用 windows 翻墙了.
我已经在我自己的服务器上实践了这个策略. 用户在使用 ssr 之前, 需要点击某个特定的页面. 在点击之后, 他们的 IP 会被抽取并广播到所有的 ssr 节点上, 并加入防火墙白名单. 在接下来的一段时间, 我将实验这种策略是否能够有效延长服务器的生存时间.
这个思路并不是我的原创, 我得到了很多人的指点和帮助, 但抱歉出于保护身份的目的, 我不能 credit 他们. 如果想讨论一些网络技术问题, 欢迎联系我的 Telegram: hiaoxui

#p 22215764 lldsolitude 我要长大 2020-04-13 18:30:54
为什么我看到的一种说法是如果服务器对抗主动探测也会被封IP？
#quote hiaoxui

#p 22215788 vimacs Lisp Interaction Paredit AC 2020-04-13 18:37:10


2020-04-13 18:35:09
看起来可以用 port knocking 实现类似功能，不过也很容易被认出来。
#quote hiaoxui

#p 22216156 sxpeter  2020-04-13 19:56:15
所以一个比较好的做法是返回正常的TLS握手的反应？
#quote lldsolitude

#p 22216282 hiaoxui 小辉 2020-04-13 20:24:42
我现在的做法是直接 drop, 连 reject 都不给返回.
#quote sxpeter

#p 22216284 hiaoxui 小辉 2020-04-13 20:26:35
服务器开了 24h 了, 没有一台挂掉. 这些服务器之前的寿命一般就是几个小时. 不过现在的数据有很大偏差, 因为我的很多用户没有适应新的操作逻辑, 流量规模其实不大.
我会继续更新实验结果.
#quote hiaoxui

#p 22216286 lldsolitude 我要长大 2020-04-13 20:27:04
那翻墙流量也得是TLS流量才行，不然特征就很明显了。
Trojan用的就是这个原理。
#quote sxpeter

#p 22218446 QUESTIONSSS 旅客 2020-04-14 09:38:50
学长好！感谢提供服务！我是计算机小白，但感觉采用现在的白名单策略可能有一点问题：
我在ipv4恢复之前一直用商业vpn，同时也关注着BBS上的恢复情况，所以常挂着代理访问SSR配置信息页面（捂脸，在ipv4恢复之后我应该也访问过，所以我的代理vpn可能已经被加入白名单了……我猜想别的同学也有类似情况，这可能会给白名单带来不必要的风险？有没有办法禁止把境外代理IP添加进白名单？
PS：我用的是安卓和windows系统
#quote hiaoxui

