#t 668 17383984 RyanBern 2019-10-31 00:00:00 RyanBern 2019-10-31 14:36:00
【端口相关】校内资源访问系统初试感受

#p 21235718 RyanBern r.bern 2019-10-31 14:21:04


2019-10-31 00:02:33
不再啰嗦，原问题见
[https://bbs.pku.edu.cn/v2/post-read.php?bid=668&amp;threadid=17378096](post-read.php?bid=668&amp;threadid=17378096)
计算中心表明已经在设计一种解决方案来解决从外网连接校内端口的问题。我也简单试了一下这个方案，跟我想象中的差不多。概括起来就是：**用一个 web 端来统一负责各种服务的访问。**
由于我平时较多用 ssh，http(s)，所以我只测试了这两个，RDP/vnc 服务我是不用的。
我本人在校内，只能通过模拟出校外的情形来测试。测试地点选择在**美国洛杉矶**。由于是我先从本地连到美国再从美国访问，体感的延迟约是**正常的两倍**，我在评判时已经去掉了这个因素。
**一、总体体验**
不太好。不知道是不是测试期的缘故，服务器在我测试的时候就宕机了两次，所以这个服务暂时相当不稳定。在访问期间我的本地计算机还莫名死机了两次（其中一次是内存爆满），死机过的机器的环境为 Ubuntu 18.04 + Firefox 70。我现在有点怀疑这个平台是不是本身就是没做好（不排除效率过低的可能）。测试期间也有符合预期的情况，但持续的时间太短了。
另：我有测过我的机器到北大校园网的延迟，看上去还是挺正常的。但向校内资源服务器有时会比这个延迟要高 1.5 倍。这个我不知道是为什么，不太像是线路的原因，有可能校内资源服务器本身负载就比较高。
[ryanbern@rb-vps5 ~]$ tcping -p 443 its.pku.edu.cnConnected to its.pku.edu.cn[:443]: seq=1 time=189.67 msConnected to its.pku.edu.cn[:443]: seq=2 time=172.65 msConnected to its.pku.edu.cn[:443]: seq=3 time=178.28 msConnected to its.pku.edu.cn[:443]: seq=4 time=168.72 ms
上传下载速度的话还是依赖线路，在我这里貌似还好（约 1 MB/s？），但还是不太稳定。
**二、SSH 服务体验**
SSH 服务这个简单说来就是实现了最基本的访问功能/不太完美的 scp 功能。其实作为一个嵌在 web 上的 ssh 用户接口感觉已经不太能改进了。之前我见过的 shellinabox 也差不多是这样，但这项目貌似 2016 年就断更了。
对我来说不能接受的是上传文件的默认位置居然是根目录，到未名一号上一看我的天哪，找到自己家目录都费劲。所以这个默认位置能不能改改？scp 上传东西莫名的慢，至少比理论上的速度慢好多，不知道是啥原因。PS：不同 scp 实现可以差非常多，例如 Windows 10 的原生 ssh 可以媲美 Linux 中的原生 ssh，但用 WinSCP 或 MobaXterm 中的内嵌 scp 经常会有跑不满速度的情况。
其他没有的功能：
1. 不能进行 x11 转发。这个对我来说好像没啥用，过去能直连的时候我也是尽量不开 x11 的。但看版上好像其他同学有需求？
2. 不能进行本地端口转发（ssh -L）。这就意味着在一个**有防火墙**的机器上你不能远程连接 jupyter-notebook，感觉这种内网穿透的操作已经很常规了？不让就不让吧。
3. 一些 shell 上的快捷键将不可用或者变得无比难用。因为客户端嵌在了 web 中，很多按键和浏览器的都会冲突。例如：Ctrl+W 在 shell 中是删除光标前一个词，但同时也是关闭浏览器选项卡！所以你想删词的时候按下 Ctrl+W 你会发现页面没了。不过理论上这个按键只是冲突了而已，web 端的 SSH 还是支持这个的。
4. 不能进行动态端口转发（ssh -D）。想到这个的你肯定是想干什么坏事。
5. 不支持在设置过 2FA 的服务器上登录。我的一些服务器安全等级比较高，在没有 pubkey 的情况下需要同时输入密码和 2FA 码。但这个登录貌似没有考虑到这个情况，只管我要了一个密码，没有地方可以输入 2FA 码。
6. 应该删除 ssh key 访问的方式，或修改。详细讨论见 [https://bbs.pku.edu.cn/v2/post-read.php?bid=668&amp;threadid=17384532](post-read.php?bid=668&amp;threadid=17384532)
**三、http(s) 服务体验**
https 体验好像还行。我有一些配置过 http redirect 的服务器，使用 http 也能自动跳转成 https，而不是傻呵呵地返回一个 301。但如果你有一些客户端需要连接 https 服务那就基本没戏了，例如 seafile 客户端。因为入校的所有客户端都由这个 web 集成了，许多自带的客户端要想连校内 https 基本上只能靠 vpn。
**Update：但 http 一直没有成功，症状是卡在跳转的界面最后显示“无法访问”，望修正。**
**四、一些展望**
目前这个方案并不理想。如果采用 web 这种方式，在功能上受限制是必然的，功能不足我是接受的。但最大的问题在于延迟和稳定性方面。如果它的延迟和稳定性不能比 vpn 好，那就基本上没有达到预期目标。我理解是这个平台本身可能效率不是很高，再加上跑的机器资源很有限，所以带来了这种体验。之前端口能用的时候为什么同学们喜欢自己开端口开服务？因为是**快速和稳定**。直连自己的端口通常会有较低的延迟和较快的上下行速度，其原因大概是同学们的服务分散到各自的私人主机上，每个主机只负责处理一个人的校外连接，自然负载就会少很多。如果像现在这样集中搞，那么对校内资源访问服务器的压力是很大的，有必要多搞几台（甚至更多）做负载均衡。不太清楚原理不太好多说了，总之让我猜可能这就是原因。
其实我倒是不太喜欢 web 端这种方式，虽然你说手机端也能用吧，但用手机连接这些东西的场合确实很少（顶多是实在着急需要看一眼）。我比较希望有一个内网穿透客户端之类的东西。学校部署好服务端后用户下载客户端，客户端登录通过验证 IAAA。每个人可以最多设置 N 条穿透规则，例如把校内主机 162.105.x.y 的 z 端口转发到本地计算机的 l 端口（好吧说白了就是一个套着 IAAA 验证壳子的 ssh 客户端）。当然内网穿透这种权限容易开太大，可能会有危险吧，计算中心也可以从类似角度考虑，因为并不是所有东西放到 web 上就一定是最好的。

#p 21236229 xinxinxinxin 欣 2019-10-31 07:14:25
@PKUCC 你看大家还是讲道理的，只是想要个更好的解决办法
#quote RyanBern

#p 21236256 xinxinxinxin 欣 2019-10-31 07:27:41
RDP和x11重度依赖…还是希望有一个没有阉割的方式，这样大家的问题确实得到了解决，也不会因为这种体验不好的方式，迟早又得再来争取一次。
你看基本上关注这个问题的人，都觉得现在这样的方式，并不算解决了问题。所以不该抛出这个网页之后就不管了。
而问题的解决方案不止这个网页这一种吧，我想世界和学校可以更美好的。
#quote RyanBern

#p 21236391 PKUCC 北京大学计算中心 2019-10-31 08:25:25
感谢你的反馈！
目前在测试期，稳定性还不够好，会有中断调试的情况，希望理解。性能方面后期我们会想办法加强。
其他你提到的部分功能，我们会和研发探讨实现的方式，期望能更好地提供服务。
#quote RyanBern

#p 21236400 PKUCC 北京大学计算中心 2019-10-31 08:28:15
依赖于图形界面的话，建议你再试试系统里的vnc功能
#quote xinxinxinxin

#p 21236727 RyanBern r.bern 2019-10-31 09:33:59
如果按照现在 web 端的思路，很多功能应该都不好做。我目前没见过用 web ssh 还能开 x11 的。目前的话计算中心应该还是希望走这条路，这个方式相对保守一些，对用户限制也很大。但确实，有些 feature 就不得不放弃了。
这个功能做好其实不太容易，绝非三两天能弄完。接下来我应该会持续关注这个系统。可能也会搞一两台 windows 机器试试 RDP。
其他我能想到的方式大概权限放的都比较开，弄不好也是十分危险的操作。例如：开几个 ssh 跳板机，学生通过 IAAA 页面开通账号（并且在 IAAA 界面上传自己的 public key，跳板机仅支持 public key 登录方式），之后学生自行建立 ssh 隧道。但这个方式可能会造成 ssh 的滥用。
#quote xinxinxinxin

#p 21237258 sxpeter  2019-10-31 11:13:20
部分具体信息我已经站内您了。
一个比较大/比较共性的问题在于，校内VPN/WPN都是单一的共用线路，不但延迟相对较高，传输文件也就通常几十到几百撑死了只有1Mb/s；而如果从校内访问外单位（反向访问同理）资源的话，则可以跑到10Mb/s以上的速度。这点问题在境外访问入校VPN的时候更为明显。
#quote PKUCC

#p 21237398 PKUCC 北京大学计算中心 2019-10-31 11:44:35
谢谢，这个问题我们正在解决
#quote sxpeter

#p 21237687 ljslcy StupidArcher 2019-10-31 13:00:25
Rstudio server, shiny server及jupyter lab重度依赖患者来顶两句
问一下楼主如果集成到web控制台以后以上三者应该怎么搞才能让校外也能访问。。
目前我是用frp穿透到校外续命，但也只能续一年...
#quote RyanBern

#p 21237724 RyanBern r.bern 2019-10-31 13:42:26


2019-10-31 13:11:18
如果你在开以上三者的服务器上没有 root 权限，且该服务器上有防火墙的话，那么应该是没有任何办法。首先有墙的话需要联系你们服务器管理员，让他帮你开端口。其次，如果管理员不同意开的话，这个 web 端很大概率不会做本地端口转发，ssh 内网穿透的功能等于没有。
如果没有 root 权限，但没有防火墙，看计算中心的描述应该是可以？具体我没测试成功，等更新。
如果你在开服务的机器上有 root 权限，可以考虑用个反向代理软件（例如 nginx）来作为你所有服务的代理，之后连 web 端选择 http(s) 服务即可。需要稍微配置一下。
#quote ljslcy

#p 21237752 PKUCC 北京大学计算中心 2019-10-31 13:21:13
目前系统各协议都支持非标准端口，你再试试？有问题的话欢迎具体反馈
#quote RyanBern

#p 21237773 xinxinxinxin 欣 2019-10-31 13:26:00
@PKUCC 一个是相较于我现在使用的方式，VNC其实不太好用。
另一个是嵌在网页里的vnc…其实不会很友好的。
另一个是我需要使用opengl渲染的话，我记得之前开vnc好像要特殊指令…
至少对我来说这个解决方案是不如vpn的，卡归卡功能都还在…
我不是很理解一个公共的网络里为什么非要封了这些功能，你可以要求我们设置我们的电脑增强安全性，可以限制我们不是对外服务，可以给出建议的跳板方案等等，但为了安全考虑直接封掉我就实在不能理解……
非要说公司的安全策略，那我之前那个公司所有电子产品不允许带进去，u盘不许插，对外的网络都监控，也不允许你从外部访问任何公司内部的数据……可是……作为一个学校，真的有必要吗？这真的是让我们的生活变得更好吗？真的是为了我们的安全考虑，让我们免受困扰吗？
#quote PKUCC

#p 21237827 RyanBern r.bern 2019-10-31 13:40:01
方式大概是选择 http 服务然后输入：域名:端口 这样？刚才测试了 http 貌似没有成功。而且奇怪的是我这边 80 端口好像也不能正常访问。本地防火墙我看了无问题。
另：选择 https 服务时，只有 www.pku.edu.cn 能正常打开，其他例如 its.pku.edu.cn 等都打不开，不知道是否是有意设置？
#quote PKUCC

#p 21237841 xinxinxinxin 欣 2019-10-31 13:42:39
其实听起来，对老哥你来说这种方案已经能解决大部分了。
可是对我需要三维结果的来说，非常不友好啊。
而且我的笔记本就没有配显卡这些，日常就是远程实验室大电脑的盒子而已。所有计算和数据都在远程电脑上，毕竟笔记本也跑不起来没啥价值。
还想5G时代也许不需要多么实在的笔记本了，只需要远程主机就可以了，那要是全世界都这么搞，诶…
@PKUCC
我还是不理解一个公共的网络里为了安全把一切功能卡死的意义所在。可以要求我们配置机器增强安全性（有些公司也是这么做的），可以提供可靠统一的连接方式，可以限制我们对外提供服务。可为了所谓的安全直接把所有功能禁掉…这个做事逻辑…电信运营商也不会这么干吧？
非要说其他公司怎么怎么样，不同公司也不一样啊，有些就是比较开放的，我也不是没在非常封闭的研究院待过，为了保密什么事都做得出来……可是作为一个学校，一个学校的网络提供机构…有必要按照最严格的方式封锁访问吗？把全世界的端口都封掉，各自搞各自的局域网，这个网络可能就很安全了？怎么想都觉得借口安全这么做是非常懒惰和负收益的行为…
#quote RyanBern

#p 21237847 xinxinxinxin 欣 2019-10-31 13:44:11
我也没成功
#quote RyanBern

#p 21237861 xinxinxinxin 欣 2019-10-31 13:47:36
说是这么说，真的能在短时间里就解决吗？那等到解决好了，有更好的方案了再禁止就等不及了了吗？
#quote PKUCC

#p 21237996 RyanBern r.bern 2019-10-31 14:17:58


2019-10-31 14:13:44
是的，从用户需求来看你比我大好多，x11 + OpenGL 这个不是原生的估计很难搞定，而目前这个方式可以说几乎不会满足你的需求了。我也只能是建议一下我希望的好方式是什么。
另外说回封端口做法的意义，你应该也看过之前我的帖子。发那个帖子之前我思考了好一会：如果换成我是计算中心的人我应该怎么做，最后我得到的结论也是全面封禁端口，不但如此我还会把 IPv6 的限制提上日程等。这个背后原因很复杂，这几天也看了不少资料，首先《办法》的制定是网信办负责，而执行者是计算中心，现在的问题是：规定已经定好了，作为执行者应该怎么理解这个规定以及怎么执行以满足这个规定？目前计算中心实行全面封禁端口原则上没有什么毛病，后果大概就是降低了用户访问校内服务的体验。但这是规定本身的问题，现在计算中心实际上在想一个既不违反规定又能尽量满足同学需求的做法，这个中间有个 balance 我认为目前没有办法完全让同学满意。我可能会再写一个邮件问一下网信办，他们的规定怎么理解，不过假设他们的回复是“学生不得开放端口对外服务”，那怎么办呢？是不是就凉透了，再揪着计算中心不放也就没有用了呀。
然后再说一下我理解《办法》中对主机提供的服务安全性保证，实际默认了我们学生没有权利来保证自己机器的安全性。但实际我认识很多同学都是很出色的运维人员（起码比某些服务器厂商来装机的工程师强很多），他们是有这个能力的。然而就是因为是学生的身份，无法申请开服务，这个问题我觉得在目前体制下无法解决。
至于把所有功能禁掉，一方面是响应政策，一方面也是防止滥用。我们有工位的同学很幸运，实验室电脑随便往墙上一插就拿到公网 IP 了，但这些其实并不是理所当然的。我见过有学校除了机房全是局域网 IP，在这种情况下该如何开服务呢？是不是只能强行内网穿透了？电信运营商给你的上网 IP 也不能用来开服务吧？如果过去北大校园网采用这种除机房外全部局域网的 IP 方式，我们现在会不会来 bbs 上发个帖要求计算中心“为办公楼分配公网 IP”？
#quote xinxinxinxin

#p 21238062 ChairmanJ 僵还是老的辣 2019-10-31 14:29:25
如果能把vpn搞到低延迟+大带宽
封禁端口的影响就不是很大了
现在校外访问vpn仅仅是能慢慢地打开网页这个水平
#quote RyanBern

#p 21238087 PKUCC 北京大学计算中心 2019-10-31 14:34:58
觉得vpn慢也可能和访问的链路有关系。方便请试试不同的入口看看是否有改善？
VPN教育网入口: [https://vpnc.pku.edu.cn](jump-to.php?url=https%3A%2F%2Fvpnc.pku.edu.cn)
VPN电信入口: [https://vpnt.pku.edu.cn](jump-to.php?url=https%3A%2F%2Fvpnt.pku.edu.cn)
VPN联通入口: [https://vpnu.pku.edu.cn](jump-to.php?url=https%3A%2F%2Fvpnu.pku.edu.cn)
VPN电信通入口: [https://vpnp.pku.edu.cn](jump-to.php?url=https%3A%2F%2Fvpnp.pku.edu.cn)
更多关于VPN使用方面的问题，请参考：[https://its.pku.edu.cn/service_1_vpn.jsp](jump-to.php?url=https%3A%2F%2Fits.pku.edu.cn%2Fservice_1_vpn.jsp)
#quote ChairmanJ

#p 21238088 RyanBern r.bern 2019-10-31 14:35:37
vpn 其实还有一个不好的地方，就是它动用了全局网络设置。在我们使用的时候基本上只有一两个服务需要入校。虽然也有办法配置本地哪些流量走 vpn 哪些流量直连就是了，但是很麻烦。
#quote ChairmanJ

