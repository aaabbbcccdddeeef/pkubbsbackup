#t 668 17383984 RyanBern 2019-10-31 00:00:00 RyanBern 2019-10-31 09:34:00
【端口相关】校内资源访问系统初试感受

#p 21235718 RyanBern r.bern 2019-10-31 00:02:33
不再啰嗦，原问题见
[https://bbs.pku.edu.cn/v2/post-read.php?bid=668&amp;threadid=17378096](post-read.php?bid=668&amp;threadid=17378096)
计算中心表明已经在设计一种解决方案来解决从外网连接校内端口的问题。我也简单试了一下这个方案，跟我想象中的差不多。概括起来就是：**用一个 web 端来统一负责各种服务的访问。**
由于我平时较多用 ssh，http(s)，所以我只测试了这两个，RDP/vnc 服务我是不用的。
我本人在校内，只能通过模拟出校外的情形来测试。测试地点选择在**美国洛杉矶**。由于是我先从本地连到美国再从美国访问，体感的延迟约是**正常的两倍**，我在评判时已经去掉了这个因素。
**一、总体体验**
不太好。不知道是不是测试期的缘故，服务器在我测试的时候就宕机了两次，所以这个服务暂时相当不稳定。在访问期间我的本地计算机还莫名死机了两次（其中一次是内存爆满），死机过的机器的环境为 Ubuntu 18.04 + Firefox 70。我现在有点怀疑这个平台是不是本身就是没做好（不排除效率过低的可能）。测试期间也有符合预期的情况，但持续的时间太短了。
另：我有测过我的机器到北大校园网的延迟，看上去还是挺正常的。但向校内资源服务器有时会比这个延迟要高 1.5 倍。这个我不知道是为什么，不太像是线路的原因，有可能校内资源服务器本身负载就比较高。
[ryanbern@rb-vps5 ~]$ tcping -p 443 its.pku.edu.cnConnected to its.pku.edu.cn[:443]: seq=1 time=189.67 msConnected to its.pku.edu.cn[:443]: seq=2 time=172.65 msConnected to its.pku.edu.cn[:443]: seq=3 time=178.28 msConnected to its.pku.edu.cn[:443]: seq=4 time=168.72 ms
上传下载速度的话还是依赖线路，在我这里貌似还好（约 1 MB/s？），但还是不太稳定。
**二、SSH 服务体验**
SSH 服务这个简单说来就是实现了最基本的访问功能/不太完美的 scp 功能。其实作为一个嵌在 web 上的 ssh 用户接口感觉已经不太能改进了。之前我见过的 shellinabox 也差不多是这样，但这项目貌似 2016 年就断更了。
对我来说不能接受的是上传文件的默认位置居然是根目录，到未名一号上一看我的天哪，找到自己家目录都费劲。所以这个默认位置能不能改改？scp 上传东西莫名的慢，至少比理论上的速度慢好多，不知道是啥原因。PS：不同 scp 实现可以差非常多，例如 Windows 10 的原生 ssh 可以媲美 Linux 中的原生 ssh，但用 WinSCP 或 MobaXterm 中的内嵌 scp 经常会有跑不满速度的情况。
其他没有的功能：
1. 不能进行 x11 转发。这个对我来说好像没啥用，过去能直连的时候我也是尽量不开 x11 的。但看版上好像其他同学有需求？
2. 不能进行本地端口转发（ssh -L）。这就意味着在一个**有防火墙**的机器上你不能远程连接 jupyter-notebook，感觉这种内网穿透的操作已经很常规了？不让就不让吧。
3. 一些 shell 上的快捷键将不可用或者变得无比难用。因为客户端嵌在了 web 中，很多按键和浏览器的都会冲突。例如：Ctrl+W 在 shell 中是删除光标前一个词，但同时也是关闭浏览器选项卡！所以你想删词的时候按下 Ctrl+W 你会发现页面没了。不过理论上这个按键只是冲突了而已，web 端的 SSH 还是支持这个的。
4. 不能进行动态端口转发（ssh -D）。想到这个的你肯定是想干什么坏事。
5. 不支持在设置过 2FA 的服务器上登录。我的一些服务器安全等级比较高，在没有 pubkey 的情况下需要同时输入密码和 2FA 码。但这个登录貌似没有考虑到这个情况，只管我要了一个密码，没有地方可以输入 2FA 码。
6. 我没有玩懂 ssh 上传 key 的这个操作，但总觉得很奇怪。上传公钥理论上说没有任何意义，如果账号管理上面是要求我们**上传私钥**，**那么请删除这个功能。**没有听说私钥要传到服务器上的说法。或者玩明白的同学给我讲解一下。
**三、http(s) 服务体验**
这个体验好像还行。我有一些配置过 http redirect 的服务器，使用 http 也能自动跳转成 https，而不是傻呵呵地返回一个 301。但如果你有一些客户端需要连接 https 服务那就基本没戏了，例如 seafile 客户端。因为入校的所有客户端都由这个 web 集成了，许多自带的客户端要想连校内 https 基本上只能靠 vpn。
**四、一些展望**
目前这个方案并不理想。如果采用 web 这种方式，在功能上受限制是必然的，功能不足我是接受的。但最大的问题在于延迟和稳定性方面。如果它的延迟和稳定性不能比 vpn 好，那就基本上没有达到预期目标。我理解是这个平台本身可能效率不是很高，再加上跑的机器资源很有限，所以带来了这种体验。之前端口能用的时候为什么同学们喜欢自己开端口开服务？因为是**快速和稳定**。直连自己的端口通常会有较低的延迟和较快的上下行速度，其原因大概是同学们的服务分散到各自的私人主机上，每个主机只负责处理一个人的校外连接，自然负载就会少很多。如果像现在这样集中搞，那么对校内资源访问服务器的压力是很大的，有必要多搞几台（甚至更多）做负载均衡。不太清楚原理不太好多说了，总之让我猜可能这就是原因。
其实我倒是不太喜欢 web 端这种方式，虽然你说手机端也能用吧，但用手机连接这些东西的场合确实很少（顶多是实在着急需要看一眼）。我比较希望有一个内网穿透客户端之类的东西。学校部署好服务端后用户下载客户端，客户端登录通过验证 IAAA。每个人可以最多设置 N 条穿透规则，例如把校内主机 162.105.x.y 的 z 端口转发到本地计算机的 l 端口（好吧说白了就是一个套着 IAAA 验证壳子的 ssh 客户端）。当然内网穿透这种权限容易开太大，可能会有危险吧，计算中心也可以从类似角度考虑，因为并不是所有东西放到 web 上就一定是最好的。

#p 21236229 xinxinxinxin 欣 2019-10-31 07:14:25
@PKUCC 你看大家还是讲道理的，只是想要个更好的解决办法
#quote RyanBern

#p 21236256 xinxinxinxin 欣 2019-10-31 07:27:41
RDP和x11重度依赖…还是希望有一个没有阉割的方式，这样大家的问题确实得到了解决，也不会因为这种体验不好的方式，迟早又得再来争取一次。
你看基本上关注这个问题的人，都觉得现在这样的方式，并不算解决了问题。所以不该抛出这个网页之后就不管了。
而问题的解决方案不止这个网页这一种吧，我想世界和学校可以更美好的。
#quote RyanBern

#p 21236391 PKUCC 北京大学计算中心 2019-10-31 08:25:25
感谢你的反馈！
目前在测试期，稳定性还不够好，会有中断调试的情况，希望理解。性能方面后期我们会想办法加强。
其他你提到的部分功能，我们会和研发探讨实现的方式，期望能更好地提供服务。
#quote RyanBern

#p 21236400 PKUCC 北京大学计算中心 2019-10-31 08:28:15
依赖于图形界面的话，建议你再试试系统里的vnc功能
#quote xinxinxinxin

#p 21236727 RyanBern r.bern 2019-10-31 09:33:59
如果按照现在 web 端的思路，很多功能应该都不好做。我目前没见过用 web ssh 还能开 x11 的。目前的话计算中心应该还是希望走这条路，这个方式相对保守一些，对用户限制也很大。但确实，有些 feature 就不得不放弃了。
这个功能做好其实不太容易，绝非三两天能弄完。接下来我应该会持续关注这个系统。可能也会搞一两台 windows 机器试试 RDP。
其他我能想到的方式大概权限放的都比较开，弄不好也是十分危险的操作。例如：开几个 ssh 跳板机，学生通过 IAAA 页面开通账号（并且在 IAAA 界面上传自己的 public key，跳板机仅支持 public key 登录方式），之后学生自行建立 ssh 隧道。但这个方式可能会造成 ssh 的滥用。
#quote xinxinxinxin

